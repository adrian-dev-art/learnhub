{% extends 'shared/base.html' %}
{% load static %}

{% block title %}{{ course.title }} - Course Viewer{% endblock %}

{% block content %}
<div class="viewer-container">
  <!-- Sidebar with modules -->
  <div class="viewer-sidebar">
    <div class="sidebar-header" style="padding: var(--spacing-lg); border-bottom: 1px solid var(--border-color);">
      <h2 class="course-title" style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-sm);">
        {{ course.title }}
      </h2>
      <div class="progress-card" style="padding: var(--spacing-sm); background: transparent; border: none;">
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="--progress: {{ enrollment.progress_percentage|default:0 }}%"></div>
        </div>
        <div class="progress-stats"
          style="margin-top: var(--spacing-xs); font-size: var(--font-size-xs); color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
          <span class="material-icons" style="font-size: 16px;">analytics</span>
          <span>{{ completed_modules|length }} / {{ modules|length }} Modules</span>
        </div>
      </div>
    </div>

    <div class="module-list" style="flex: 1; overflow-y: auto; padding: var(--spacing-sm);">
      {% for module in modules %}
      {% if not module.is_completed and module.id != first_incomplete.id and not is_preview %}
      <div class="module-item locked"
        style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-md); opacity: 0.5; cursor: not-allowed;">
        <span class="material-icons">lock</span>
        <div class="module-info">
          <div class="module-title" style="font-size: var(--font-size-sm); font-weight: 600;">{{ module.title }}</div>
          <div class="module-meta" style="font-size: var(--font-size-xs); color: var(--text-muted);">
            {{ module.get_content_type_display }}
          </div>
        </div>
      </div>
      {% else %}
      <a href="?module_id={{ module.id }}{% if is_preview %}&preview=true&course_id={{ course.id }}{% endif %}"
        class="module-item {% if module.is_current %}active{% endif %}"
        style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-md); text-decoration: none; border-radius: var(--radius-lg); transition: all var(--transition-fast); background: {% if module.is_current %}var(--primary-light){% else %}transparent{% endif %}; color: {% if module.is_current %}var(--primary){% else %}var(--text-main){% endif %};">
        <span class="material-icons {% if module.is_completed %}completed{% endif %}"
          style="color: {% if module.is_completed %}var(--success){% else %}inherit{% endif %};">
          {% if module.is_completed %}check_circle
          {% elif module.content_type == 'assessment' %}assignment
          {% else %}article{% endif %}
        </span>
        <div class="module-info">
          <div class="module-title" style="font-size: var(--font-size-sm); font-weight: 600;">{{ module.title }}</div>
          <div class="module-meta" style="font-size: var(--font-size-xs); opacity: 0.7;">
            {{ module.get_content_type_display }}
          </div>
        </div>
      </a>
      {% endif %}
      {% endfor %}
    </div>

    <div class="sidebar-footer" style="padding: var(--spacing-lg); border-top: 1px solid var(--border-color);">
      {% if not is_preview and course.assessment %}
      <a href="{% url 'assessment_view' enrollment.id %}" class="btn-primary-premium"
        style="padding: var(--spacing-md); font-size: var(--font-size-sm);">
        <span class="material-icons">assignment</span>
        <span>Final Assessment</span>
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Main content area -->
  <div class="viewer-main">
    <div class="content-wrapper" style="max-width: 800px; margin: 0 auto;">
      <div class="content-header animate-fade-in" style="margin-bottom: var(--spacing-2xl);">
        <div class="breadcrumb"
          style="display: flex; align-items: center; gap: 4px; font-size: var(--font-size-xs); color: var(--text-muted); margin-bottom: var(--spacing-md);">
          <a href="{% url 'catalog' %}" style="color: inherit; text-decoration: none;">Catalog</a>
          <span class="material-icons" style="font-size: 14px;">chevron_right</span>
          <span>{{ course.title }}</span>
        </div>
        <h1 class="module-display-title"
          style="font-size: var(--font-size-3xl); font-weight: 800; color: var(--text-main); margin-bottom: var(--spacing-sm);">
          {{ current_module.title }}</h1>
        <div class="badge-premium">
          <span class="material-icons">description</span>
          <span>{{ current_module.get_content_type_display }}</span>
        </div>
      </div>

      <div id="content-viewer" class="rich-content">
        {{ current_module.content_html|safe }}
      </div>

      <!-- Pass content safely via JSON script tag -->
      {{ current_module.content|json_script:"module-content-data" }}

      {% if current_module.content_type == 'code' %}
      <div class="code-exercise-container" data-language="{{ current_module.language|default:'python' }}"
        style="margin-top: var(--spacing-2xl);">
        <div class="content-card" style="padding: 0; overflow: hidden; background: #1e1e1e;">
          <div class="editor-header"
            style="background: #252526; padding: var(--spacing-sm) var(--spacing-lg); display: flex; justify-content: space-between; align-items: center;">
            <div class="tab active"
              style="color: #fff; display: flex; align-items: center; gap: 8px; font-size: var(--font-size-sm);">
              <span class="material-icons" style="color: #358ccb;">code</span>
              <span>main.py</span>
            </div>
            <button onclick="runCode()" class="btn-primary-premium"
              style="padding: var(--spacing-xs) var(--spacing-md); font-size: var(--font-size-xs); width: auto; background: var(--success);">
              <span class="material-icons">play_arrow</span>
              <span>Run Code</span>
            </button>
          </div>
          <textarea id="codeEditor" spellcheck="false"
            style="width: 100%; min-height: 300px; background: transparent; color: #9cdcfe; border: none; padding: var(--spacing-lg); font-family: var(--font-mono); font-size: 14px; outline: none; resize: vertical;">{{ current_module.starter_code|default:"# Write your code here\nprint('Hello, World!')" }}</textarea>
        </div>
        <div id="output" class="content-card"
          style="display: none; background: #0f172a; border-color: #334155; padding: var(--spacing-lg);">
          <pre id="outputContent"
            style="margin: 0; color: #e2e8f0; font-family: var(--font-mono); font-size: 13px; white-space: pre-wrap;"></pre>
        </div>
      </div>
      {% endif %}



      <!-- Module Mini Quiz -->
      {% if current_module.quiz_data %}
      <div id="module-quiz-root" style="margin-top: var(--spacing-2xl);"></div>
      {{ current_module.quiz_data|json_script:"module-quiz-data" }}
      {{ saved_quiz_data|json_script:"saved-quiz-data-script" }}
      {% endif %}

      <div class="content-footer"
        style="margin-top: var(--spacing-4xl); padding-top: var(--spacing-2xl); border-top: 1px solid var(--border-color); display: flex; justify-content: center;">
        {% if current_module.id != modules.last.id %}
        {% if is_preview %}
        <a href="?module_id={{ current_module.id|add:1 }}&preview=true&course_id={{ course.id }}"
          class="btn-primary-premium" style="width: auto; padding: var(--spacing-md) var(--spacing-2xl);">
          <span>Next Lesson</span>
          <span class="material-icons">arrow_forward</span>
        </a>
        {% else %}
        <button class="btn-primary-premium" onclick="markCompleteAndNext({{ current_module.id|default:0 }})"
          style="width: auto; padding: var(--spacing-md) var(--spacing-2xl);">
          <span>Next Lesson</span>
          <span class="material-icons">arrow_forward</span>
        </button>
        {% endif %}
        {% else %}
        {% if not is_preview and course.assessment %}
        <a href="{% url 'assessment_view' enrollment.id %}" class="btn-primary-premium"
          style="width: auto; padding: var(--spacing-md) var(--spacing-2xl);">
          <span>Take Final Assessment</span>
          <span class="material-icons">assignment_turned_in</span>
        </a>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const viewer = document.getElementById('content-viewer');
    const dataElement = document.getElementById('module-content-data');

    if (dataElement) {
      let content = "";
      try {
        content = JSON.parse(dataElement.textContent);
      } catch (e) {
        console.error("Error parsing content JSON:", e);
        content = dataElement.textContent;
      }

      // Render content if needed (legacy)
      if (typeof content === 'object' && content.blocks) {
        viewer.innerHTML = '<p>Legacy content format. Please update module.</p>';
      }
    }

    // Initialize Mini Quizzes
    initQuizzes();

    // Initialize Embedded Runnable Blocks
    initRunnableBlocks();

    // Initialize Module Quiz
    initModuleQuiz();
  });

  function initModuleQuiz() {
    const quizDataEl = document.getElementById('module-quiz-data');
    if (!quizDataEl) return;

    let quizData = [];
    try {
      quizData = JSON.parse(quizDataEl.textContent);
    } catch (e) {
      console.error("Error parsing quiz data", e);
      return;
    }

    if (!quizData || quizData.length === 0) return;

    const root = document.getElementById('module-quiz-root');
    let userAnswers = {};
    let submitted = false;

    // Load saved data
    let savedData = {};
    const savedDataScript = document.getElementById('saved-quiz-data-script');
    if (savedDataScript) {
      try {
        savedData = JSON.parse(savedDataScript.textContent);
      } catch (e) {
        console.error("Error parsing saved quiz data", e);
      }
    }

    if (savedData && savedData.answers) {
      userAnswers = savedData.answers;
      submitted = true;
    }

    function render() {
      root.innerHTML = quizData.map((q, i) => `
        <div class="quiz-question">
          <h4>${i + 1}. ${q.question}</h4>
          <div class="quiz-options">
            ${q.options.map((opt, optIndex) => {
        const isSelected = userAnswers[i] === optIndex;
        let statusClass = '';

        // Determine correct index (support both new index-based and legacy string-based)
        let correctIndex = q.correct_index;
        if (correctIndex === undefined && q.correct_answer) {
          correctIndex = q.options.indexOf(q.correct_answer);
        }

        if (submitted) {
          if (optIndex === correctIndex) statusClass = 'correct';
          else if (isSelected && optIndex !== correctIndex) statusClass = 'incorrect';
        } else if (isSelected) {
          statusClass = 'selected';
        }

        return `
              <div class="quiz-option ${statusClass}" onclick="selectOption(${i}, ${optIndex})">
                <div style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid currentColor; display: flex; align-items: center; justify-content: center;">
                  ${isSelected || (submitted && optIndex === correctIndex) ? '<div style="width: 10px; height: 10px; border-radius: 50%; background: currentColor;"></div>' : ''}
                </div>
                <span>${opt}</span>
                ${submitted && optIndex === correctIndex ? '<span class="material-icons" style="margin-left: auto; color: #22c55e;">check_circle</span>' : ''}
                ${submitted && isSelected && optIndex !== correctIndex ? '<span class="material-icons" style="margin-left: auto; color: #ef4444;">cancel</span>' : ''}
              </div>
              `;
      }).join('')}
          </div>
        </div>
      `).join('');

      if (!submitted) {
        const allAnswered = quizData.every((_, i) => userAnswers[i] !== undefined);
        root.innerHTML += `
          <button class="btn btn-primary" onclick="submitQuiz()" ${!allAnswered ? 'disabled' : ''} style="margin-top: 16px;">
            Check Answers
          </button>
        `;
      } else {
        const correctCount = quizData.filter((q, i) => {
          const selectedOptIndex = userAnswers[i];
          let correctIndex = q.correct_index;
          if (correctIndex === undefined && q.correct_answer) {
            correctIndex = q.options.indexOf(q.correct_answer);
          }
          return selectedOptIndex === correctIndex;
        }).length;

        const score = Math.round((correctCount / quizData.length) * 100);
        root.innerHTML += `
          <div style="margin-top: 24px; padding: 16px; background: ${score === 100 ? '#f0fdf4' : '#fff7ed'}; border-radius: 12px; border: 1px solid ${score === 100 ? '#bbf7d0' : '#fed7aa'};">
            <h4 style="margin: 0; color: ${score === 100 ? '#15803d' : '#c2410c'};">
              You scored ${score}% (${correctCount}/${quizData.length})
            </h4>
            <button class="btn btn-secondary btn-sm" onclick="retryQuiz()" style="margin-top: 12px;">Retry Quiz</button>
          </div>
        `;
      }
    }

    window.selectOption = function (qIndex, optIndex) {
      if (submitted) return;
      userAnswers[qIndex] = optIndex;
      render();
    };

    window.submitQuiz = function () {
      submitted = true;
      render();

      // Save progress
      {% if not is_preview %}
      const correctCount = quizData.filter((q, i) => {
        const selectedOptIndex = userAnswers[i];
        let correctIndex = q.correct_index;
        if (correctIndex === undefined && q.correct_answer) {
          correctIndex = q.options.indexOf(q.correct_answer);
        }
        return selectedOptIndex === correctIndex;
      }).length;
      const score = Math.round((correctCount / quizData.length) * 100);

      const url = '{% url "save_module_quiz_progress" enrollment.id 999999 %}'.replace('999999', '{{ current_module.id|default:0 }}');
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          answers: userAnswers,
          score: score
        })
      }).catch(err => console.error("Failed to save quiz progress", err));
      {% endif %}
    };

    window.retryQuiz = function () {
      userAnswers = {};
      submitted = false;
      render();
    };

    render();
  }

  {% if not is_preview %}
  function markCompleteAndNext(moduleId) {
    if (!moduleId || moduleId === '0' || moduleId === 0) return;

    // Use a unique placeholder to avoid replacing parts of the enrollment ID
    const url = '{% url "mark_module_complete" enrollment.id 999999 %}'.replace('999999', moduleId);

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = '{% url "course_viewer" enrollment.id %}';
        }
      })
      .catch(error => console.error('Error:', error));
  }
  {% else %}
  function markCompleteAndNext(moduleId) {
    console.log("Preview mode: completion not tracked.");
  }
  {% endif %}

  function initRunnableBlocks() {
    const codeBlocks = document.querySelectorAll('.runnable-code');
    codeBlocks.forEach((block, index) => {
      const code = block.textContent;
      const language = block.dataset.language || 'python';

      const container = document.createElement('div');
      container.className = 'interactive-code-runner';
      container.innerHTML = `
            <div class="runner-header">
                <span class="runner-title">Interactive ${language}</span>
                <button class="btn-run-small" onclick="runEmbeddedBlock(${index})">
                    <span class="material-icons">play_arrow</span> Run
                </button>
            </div>
            <div class="runner-editor">
                <textarea id="embedded-code-${index}" spellcheck="false">${code}</textarea>
            </div>
            <div class="runner-io">
                <div class="io-section">
                    <label>Input (stdin)</label>
                    <textarea id="embedded-input-${index}" placeholder="Enter input here..."></textarea>
                </div>
                <div class="io-section">
                    <label>Output</label>
                    <pre id="embedded-output-${index}" class="runner-output"></pre>
                </div>
            </div>
        `;

      block.parentNode.replaceChild(container, block);
    });
  }

  function runEmbeddedBlock(index) {
    const code = document.getElementById(`embedded-code-${index}`).value;
    const input = document.getElementById(`embedded-input-${index}`).value;
    const outputPre = document.getElementById(`embedded-output-${index}`);

    outputPre.textContent = 'Running...';
    outputPre.style.color = '#94a3b8';

    fetch('{% url "execute_code" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ code: code, inputs: input })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          outputPre.textContent = data.output || '(No output)';
          outputPre.style.color = '#e2e8f0';
        } else {
          outputPre.textContent = 'Error:\n' + (data.error || 'Unknown error');
          outputPre.style.color = '#ef4444';
        }
      })
      .catch(error => {
        outputPre.textContent = 'System Error: ' + error.message;
        outputPre.style.color = '#ef4444';
      });
  }

  function initQuizzes() {
    const quizzes = document.querySelectorAll('.interactive-quiz');
    quizzes.forEach((quiz, index) => {
      const question = quiz.dataset.question;
      const options = quiz.dataset.options.split('|');
      const correctAnswer = parseInt(quiz.dataset.answer);

      const container = document.createElement('div');
      container.className = 'quiz-widget';

      let optionsHtml = '';
      options.forEach((opt, i) => {
        optionsHtml += `
                <label class="quiz-option" id="quiz-${index}-opt-${i}">
                    <input type="radio" name="quiz-${index}" value="${i}">
                    <span class="option-text">${opt}</span>
                    <span class="option-feedback material-icons"></span>
                </label>
            `;
      });

      container.innerHTML = `
            <div class="quiz-header">
                <span class="material-icons">quiz</span>
                <span>Mini Quiz</span>
            </div>
            <div class="quiz-body">
                <p class="quiz-question">${question}</p>
                <div class="quiz-options-list">
                    ${optionsHtml}
                </div>
                <div class="quiz-footer">
                    <button class="btn-check-answer" onclick="checkQuiz(${index}, ${correctAnswer})">Check Answer</button>
                    <span id="quiz-result-${index}" class="quiz-result-msg"></span>
                </div>
            </div>
        `;

      quiz.parentNode.replaceChild(container, quiz);
    });
  }

  function checkQuiz(index, correctIndex) {
    const selected = document.querySelector(`input[name="quiz-${index}"]:checked`);
    const resultMsg = document.getElementById(`quiz-result-${index}`);

    // Reset styles
    document.querySelectorAll(`input[name="quiz-${index}"]`).forEach(input => {
      input.parentElement.classList.remove('correct', 'incorrect');
    });

    if (!selected) {
      resultMsg.textContent = "Please select an answer.";
      resultMsg.className = "quiz-result-msg warning";
      return;
    }

    const selectedVal = parseInt(selected.value);
    const selectedLabel = document.getElementById(`quiz-${index}-opt-${selectedVal}`);

    if (selectedVal === correctIndex) {
      selectedLabel.classList.add('correct');
      resultMsg.textContent = "Correct! Well done.";
      resultMsg.className = "quiz-result-msg success";
    } else {
      selectedLabel.classList.add('incorrect');
      resultMsg.textContent = "Incorrect. Try again!";
      resultMsg.className = "quiz-result-msg error";
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function runCode() {
    const code = document.getElementById('codeEditor').value;
    const outputDiv = document.getElementById('output');
    const outputContent = document.getElementById('outputContent');
    const container = document.querySelector('.code-exercise-container');
    const language = container ? container.dataset.language : 'python';

    outputDiv.style.display = 'block';
    outputContent.textContent = 'Running...';
    outputContent.style.color = '#94a3b8';

    if (language === 'javascript') {
      // Client-side JavaScript execution
      const originalLog = console.log;
      const logs = [];

      try {
        console.log = function (...args) {
          logs.push(args.map(arg => String(arg)).join(' '));
          originalLog.apply(console, args);
        };

        // Run the code
        eval(code);

        outputContent.textContent = logs.length > 0 ? logs.join('\n') : 'Code executed successfully (no output)';
        outputContent.style.color = '#10b981';
      } catch (e) {
        outputContent.textContent = 'Error: ' + e.message;
        outputContent.style.color = '#ef4444';
      } finally {
        // Restore console.log
        console.log = originalLog;
      }
    } else if (language === 'html') {
      // HTML Preview
      const win = window.open('', '_blank');
      win.document.write(code);
      win.document.close();
      outputContent.textContent = 'HTML preview opened in a new window/tab.';
      outputContent.style.color = '#10b981';
    } else {
      // Python (Server-side)
      fetch('{% url "execute_code" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ code: code })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            outputContent.textContent = data.output || 'Code executed successfully (no output)';
            outputContent.style.color = '#10b981';
          } else {
            outputContent.textContent = 'Error:\n' + (data.error || 'Unknown error');
            outputContent.style.color = '#ef4444';
          }
        })
        .catch(error => {
          outputContent.textContent = 'Error: ' + error.message;
          outputContent.style.color = '#ef4444';
        });
    }
  }
</script>
{% endblock %}
